<script type="module">
  // Use ONE Firebase version (v10 here) and one init
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInAnonymously,
    signInWithPopup,
    GoogleAuthProvider,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getStorage,
    ref,
    uploadBytesResumable,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  // ✅ Your Firebase config (use your real values)
  const firebaseConfig = {
    apiKey: "AIzaSyCUMWDE3_NI06fm-Bm31XjLS8-scmVQ8aw",
    authDomain: "marlidu-b3b95.firebaseapp.com",
    projectId: "marlidu-b3b95",
    // ✅ Fix: appspot.com (not firebasestorage.app)
    storageBucket: "marlidu-b3b95.appspot.com",
    messagingSenderId: "152143515296",
    appId: "1:152143515296:web:4509f8f8ca385bfa5a83c5"
  };

  // Init once
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const storage = getStorage(app);

  // --- UI refs
  const fileEl   = document.getElementById("file");
  const uploadBtn= document.getElementById("uploadBtn");
  const signInBtn= document.getElementById("signInBtn");
  const signOutBtn=document.getElementById("signOutBtn");
  const statusEl = document.getElementById("status");
  const progEl   = document.getElementById("prog");
  const resultEl = document.getElementById("result");

  // Auth state
  onAuthStateChanged(auth, (user) => {
    if (user) {
      statusEl.innerHTML = `Signed in as <code>${user.uid}${user.email ? " (" + user.email + ")" : ""}</code>`;
    } else {
      statusEl.textContent = "Not signed in.";
    }
  });

  // Anonymous sign-in (if you enabled it)
  async function ensureSignedIn() {
    if (!auth.currentUser) {
      await signInAnonymously(auth);
    }
  }

  // Buttons
  signInBtn.addEventListener("click", async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    } catch (e) {
      alert("Sign-in failed: " + e.message);
      console.error(e);
    }
  });

  signOutBtn.addEventListener("click", async () => {
    try { await signOut(auth); } catch (e) { console.error(e); }
  });

  // Upload
  uploadBtn.addEventListener("click", async () => {
    try {
      await ensureSignedIn();

      const file = fileEl.files?.[0];
      if (!file) return alert("Pick a file first.");

      const MAX = 50 * 1024 * 1024; // keep ≤ your Storage rules limit
      if (file.size > MAX) return alert("File too large.");

      const ts = new Date().toISOString().replaceAll(":","-");
      const storagePath = `resources/uploads/${ts}_${file.name}`;
      const storageRef = ref(storage, storagePath);

      resultEl.innerHTML = "";
      progEl.hidden = false; progEl.value = 0;
      uploadBtn.disabled = true;

      const task = uploadBytesResumable(storageRef, file, {
        contentType: file.type || "application/octet-stream",
      });

      task.on("state_changed",
        (snap) => {
          const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
          progEl.value = pct;
          statusEl.innerHTML = `Uploading… <code>${pct}%</code>`;
        },
        (error) => {
          progEl.hidden = true;
          uploadBtn.disabled = false;
          statusEl.innerHTML = `<span class="err">Error: ${error.message}</span>`;
          console.error(error);
        },
        async () => {
          const url = await getDownloadURL(task.snapshot.ref);
          progEl.hidden = true;
          uploadBtn.disabled = false;
          statusEl.innerHTML = `<span class="ok">Uploaded ✔</span>`;
          resultEl.innerHTML = `
            <div>Path: <code>${storagePath}</code></div>
            <div>URL: <a href="${url}" target="_blank" rel="noopener">${url}</a></div>
          `;
          console.log("Uploaded ✔ URL:", url);
        }
      );
    } catch (e) {
      progEl.hidden = true;
      uploadBtn.disabled = false;
      statusEl.innerHTML = `<span class="err">Error: ${e.message}</span>`;
      console.error(e);
    }
  });
</script>
