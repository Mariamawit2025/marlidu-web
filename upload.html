<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInAnonymously, signInWithPopup, GoogleAuthProvider, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getStorage, ref, uploadBytesResumable, getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCUMWDE3_NI06fm-Bm31XjLS8-scmVQ8aw",
    authDomain: "marlidu-b3b95.firebaseapp.com",
    projectId: "marlidu-b3b95",
    storageBucket: "marlidu-b3b95.appspot.com",
    messagingSenderId: "152143515296",
    appId: "1:152143515296:web:4509f8f8ca385bfa5a83c5"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const storage = getStorage(app);

  window.addEventListener('DOMContentLoaded', () => {
    // --- UI refs (after DOM is ready)
    const fileEl     = document.getElementById("file");
    const uploadBtn  = document.getElementById("uploadBtn");
    const signInBtn  = document.getElementById("signInBtn");
    const signOutBtn = document.getElementById("signOutBtn");
    const statusEl   = document.getElementById("status");
    const progEl     = document.getElementById("prog");
    const resultEl   = document.getElementById("result");

    // Guard: if any are missing, log which one
    const ids = {fileEl, uploadBtn, signInBtn, signOutBtn, statusEl, progEl, resultEl};
    for (const [k, v] of Object.entries(ids)) {
      if (!v) { console.error(`Missing element for ${k}. Check the ID in your HTML.`); }
    }

    onAuthStateChanged(auth, (user) => {
      if (statusEl) {
        statusEl.innerHTML = user
          ? `Signed in as <code>${user.uid}${user.email ? " ("+user.email+")" : ""}</code>`
          : "Not signed in.";
      }
    });

    async function ensureSignedIn() {
      if (!auth.currentUser) await signInAnonymously(auth);
    }

    if (signInBtn) {
      signInBtn.addEventListener("click", async () => {
        try { await signInWithPopup(auth, new GoogleAuthProvider()); }
        catch (e) { alert("Sign-in failed: " + e.message); console.error(e); }
      });
    }

    if (signOutBtn) {
      signOutBtn.addEventListener("click", async () => {
        try { await signOut(auth); } catch (e) { console.error(e); }
      });
    }

    if (uploadBtn) {
      uploadBtn.addEventListener("click", async () => {
        try {
          await ensureSignedIn();
          const file = fileEl?.files?.[0];
          if (!file) return alert("Pick a file first.");

          const ts = new Date().toISOString().replaceAll(":","-");
          const storagePath = `resources/uploads/${ts}_${file.name}`;
          const storageRef = ref(storage, storagePath);

          if (progEl) { progEl.hidden = false; progEl.value = 0; }
          uploadBtn.disabled = true;

          const task = uploadBytesResumable(storageRef, file, {
            contentType: file.type || "application/octet-stream"
          });

          task.on("state_changed",
            (snap) => {
              if (progEl) progEl.value = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
            },
            (error) => {
              if (progEl) progEl.hidden = true;
              uploadBtn.disabled = false;
              if (statusEl) statusEl.innerHTML = `<span class="err">${error.message}</span>`;
              console.error("Upload error:", error.code, error.message);
            },
            async () => {
              const url = await getDownloadURL(task.snapshot.ref);
              if (progEl) progEl.hidden = true;
              uploadBtn.disabled = false;
              if (statusEl) statusEl.innerHTML = `<span class="ok">Uploaded ✔</span>`;
              if (resultEl) resultEl.innerHTML = `Path: <code>${storagePath}</code><br>URL: <a href="${url}" target="_blank" rel="noopener">${url}</a>`;
              console.log("Uploaded ✔ URL:", url);
            }
          );
        } catch (e) {
          if (progEl) progEl.hidden = true;
          uploadBtn.disabled = false;
          if (statusEl) statusEl.innerHTML = `<span class="err">${e.message}</span>`;
          console.error(e);
        }
      });
    }
  });
</script>
