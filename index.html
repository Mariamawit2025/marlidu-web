<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MarLidu â€“ CNS Rater Training</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto; background:linear-gradient(180deg,#0a2a5c,#0b5a66); color:#fff; }
    .wrap { max-width:900px; margin:40px auto; padding:0 16px; display:grid; gap:16px; }
    header { display:flex; justify-content:space-between; align-items:center; padding:14px 0; border-bottom:1px solid #ffffff22; }
    h1 { margin:0; font-size:22px; }
    section { background:#ffffff; color:#05324f; border-radius:14px; padding:16px; box-shadow:0 8px 28px rgba(0,0,0,.12); }
    label { display:block; font-size:12px; opacity:.8; margin-bottom:4px; }
    input, select, button { font:inherit; padding:8px 10px; border-radius:8px; border:1px solid #cfe0ff; }
    button { background:#17c0ae; color:#05324f; border:none; font-weight:700; cursor:pointer; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill { background:#0b5a66; color:#e8ffff; border:1px solid #2ac7ba; border-radius:999px; padding:8px 14px; text-decoration:none; }
    .muted { color:#333; font-size:14px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex;gap:10px;align-items:center">
        <div style="width:36px;height:36px;border-radius:8px;background:#17c0ae;color:#05324f;display:grid;place-items:center;font-weight:800">M</div>
        <div>
          <h1>MarLidu</h1>
          <div style="font-size:12px;opacity:.8">CNS Rater Training & Clinical Trial Excellence</div>
        </div>
      </div>
      <div id="authBox" class="row"></div>
    </header>

    <div class="row">
      <a class="pill" href="#modules">Modules</a>
      <a class="pill" href="#upload">Admin Upload</a>
    </div>

    <section id="modules">
      <h3>Training Modules</h3>
      <div class="muted">MDD Â· Schizophrenia Â· Bipolar</div>
      <div id="resourceList" class="muted" style="margin-top:8px">No resources yet.</div>
    </section>

    <section id="upload">
      <h3>Admin Upload (video/audio/PDF/PPT)</h3>
      <div class="row">
        <div>
          <label>Module</label>
          <select id="moduleSel">
            <option value="mdd">MDD</option>
            <option value="scz">Schizophrenia</option>
            <option value="bipolar">Bipolar</option>
          </select>
        </div>
        <div>
          <label>File</label>
          <input type="file" id="fileInp" />
        </div>
        <button id="uploadBtn">Upload</button>
        <span id="uploadMsg" class="muted"></span>
        <!-- NEW: progress bar -->
        <progress id="uploadProgress" value="0" max="100" style="width:220px; vertical-align:middle; margin-left:6px;"></progress>
      </div>
      <div class="muted" style="margin-top:6px">Accepted: mp4, webm, mov, mp3, wav, m4a, pdf, ppt, pptx</div>
    </section>
  </div>

  <!-- Firebase connection status badge -->
  <div id="firebase-status" style="position:fixed;right:10px;bottom:10px;background:#0b5a66;color:#e8ffff;padding:6px 10px;border-radius:8px;font-size:12px">
    connectingâ€¦
  </div>

  <!-- Firebase (ESM via CDN) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // ðŸ”§ YOUR CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyCUMWDE3_NI06fm-Bm31XjLS8-scmVQ8aw",
      authDomain: "marlidu-b3b95.firebaseapp.com",
      projectId: "marlidu-b3b95",
      storageBucket: "marlidu-b3b95.appspot.com",
      messagingSenderId: "152143515296",
      appId: "1:152143515296:web:4509f8f8ca385bfa5a83c5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // simple connection test
    const statusEl = document.getElementById("firebase-status");
    function setStatus(msg) { if (statusEl) statusEl.textContent = msg; }
    setStatus("Firebase connected âœ“");
    console.log("Firebase project:", app.options.projectId);

    // â€”â€”â€” simple admin allowlist (lowercased) â€”â€”â€”
    const ADMIN_EMAILS = ["yosephtworku@gmail.com"].map(e => e.toLowerCase());

    // UI elements
    const authBox = document.getElementById("authBox");
    const fileInp = document.getElementById("fileInp");
    const moduleSel = document.getElementById("moduleSel");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadMsg = document.getElementById("uploadMsg");
    const resourceList = document.getElementById("resourceList");
    const progressEl = document.getElementById("uploadProgress");

    function renderAuth(user) {
      authBox.innerHTML = "";
      if (user) {
        const span = document.createElement("span");
        span.textContent = `Signed in as ${user.email}`;
        span.style.fontSize = "12px";
        span.style.opacity = "0.9";
        const btn = document.createElement("button");
        btn.textContent = "Sign out";
        btn.onclick = () => signOut(auth);
        authBox.append(span, btn);
      } else {
        const email = document.createElement("input");
        email.placeholder = "admin email";
        const pass = document.createElement("input");
        pass.placeholder = "password";
        pass.type = "password";
        const btn = document.createElement("button");
        btn.textContent = "Sign in";
        btn.onclick = async () => {
          try {
            await signInWithEmailAndPassword(auth, email.value, pass.value);
          } catch (e) { alert(e.message); }
        };
        authBox.append(email, pass, btn);
      }
    }

    async function listResources() {
      const snap = await getDocs(query(collection(db, "resources"), orderBy("createdAt", "desc")));
      if (snap.empty) { resourceList.textContent = "No resources yet."; return; }
      // render as clickable links
      const frag = document.createDocumentFragment();
      snap.forEach(d => {
        const r = d.data();
        const a = document.createElement("a");
        a.href = r.url;
        a.target = "_blank";
        a.rel = "noreferrer";
        a.textContent = `${r.moduleId.toUpperCase()} Â· ${r.type} Â· ${r.name}`;
        a.style.marginRight = "12px";
        frag.appendChild(a);
      });
      resourceList.innerHTML = "";
      resourceList.appendChild(frag);
    }

    function guessType(name) {
      const n = name.toLowerCase();
      if (/\.(mp4|webm|mov)$/.test(n)) return "video";
      if (/\.(mp3|wav|m4a)$/.test(n)) return "audio";
      if (/\.(pdf)$/.test(n)) return "pdf";
      if (/\.(ppt|pptx)$/.test(n)) return "ppt";
      return "file";
    }

    // NEW: resumable upload with progress
    uploadBtn.onclick = async () => {
      const user = auth.currentUser;
      if (!user) return alert("Sign in first.");
      if (!ADMIN_EMAILS.includes((user.email || "").toLowerCase())) return alert("Admin only.");

      const f = fileInp.files?.[0];
      if (!f) return alert("Choose a file.");

      const MAX_MB = 500; // optional guard
      const sizeMB = (f.size / (1024 * 1024)).toFixed(1);
      if (f.size > MAX_MB * 1024 * 1024) {
        return alert(`File is ${sizeMB} MB. Please upload â‰¤ ${MAX_MB} MB or compress it.`);
      }

      const ok = /\.(mp4|webm|mov|mp3|wav|m4a|pdf|ppt|pptx)$/i.test(f.name);
      if (!ok) return alert("Unsupported type. Use video/audio/pdf/ppt/pptx.");

      const start = Date.now();
      uploadMsg.textContent = `Starting uploadâ€¦ (${sizeMB} MB)`;
      if (progressEl) progressEl.value = 0;

      const path = `resources/${moduleSel.value}/${Date.now()}_${f.name}`;
      const r = ref(storage, path);
      const metadata = { contentType: f.type || undefined };

      const task = uploadBytesResumable(r, f, metadata);

      task.on(
        "state_changed",
        (snap) => {
          const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
          if (progressEl) progressEl.value = pct;

          let speed = "";
          const elapsed = (Date.now() - start) / 1000;
          if (elapsed > 1) {
            const kbps = (snap.bytesTransferred / 1024 / elapsed).toFixed(1);
            speed = ` â€¢ ~${kbps} KB/s`;
          }
          uploadMsg.textContent = `Uploadingâ€¦ ${pct}%${speed}`;
        },
        (err) => {
          let msg = err.message || String(err);
          if (String(err.code || "").includes("permission-denied")) {
            msg = "Permission denied. Check Storage rules and admin email.";
          }
          uploadMsg.textContent = `Upload failed: ${msg}`;
          console.error(err);
        },
        async () => {
          const url = await getDownloadURL(task.snapshot.ref);
          await addDoc(collection(db, "resources"), {
            moduleId: moduleSel.value,
            name: f.name,
            type: guessType(f.name),
            url,
            createdAt: serverTimestamp(),
            createdBy: user.uid
          });
          uploadMsg.textContent = "Uploaded âœ”";
          if (progressEl) progressEl.value = 100;
          fileInp.value = "";
          await listResources();
        }
      );
    };

    onAuthStateChanged(auth, async (u) => {
      renderAuth(u);
    });

    // show any existing resources on first load
    listResources().catch(console.error);
  </script>
</body>
</html>
